<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classifier Squares Visualization</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            padding: 20px;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ Classifier Squares Visualization</h1>

        <div>
          <label>üëÅÔ∏è View ModeÔºö</label>
          <select id="view_mode">
            <option value="boxes" selected>Boxes</option>
            <option value="stacks">Stacks</option>
          </select>
        </div>
        <br>

        <div id="tooltip" style="position: absolute; display: none; background: white; border: 1px solid #ccc; padding: 5px; pointer-events: none; font-size: 12px; z-index: 1000; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></div>

        <div id="multi-class-container" style="width: 100%; min-height: 900px; overflow: auto; border:1px solid #ccc; padding:30px; background-color: #fafafa;">
          <div id="multi-class-vis"></div>

          <!-- Control Panel -->
          <div id="controls" style="margin-top: 20px; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
              <div>
                <label style="font-weight: bold;">üîó Parallel Coordinates:</label>
                <button id="toggle-polylines" style="margin-left: 5px; padding: 5px 10px; background: #2ecc71; color: white; border: none; border-radius: 3px;">Show</button>
                <small style="margin-left: 5px; color: #666;">Hover instances to see cross-class scores</small>
              </div>
              <div>
                <label style="font-weight: bold;">‚≠ê Bookmarks:</label>
                <span id="bookmark-count" style="margin-left: 5px; color: #666;">0 instances</span>
                <button id="clear-bookmarks" style="margin-left: 10px; padding: 5px 10px; background: #e74c3c; color: white; border: none; border-radius: 3px;">Clear</button>
              </div>
              <div>
                <label style="font-weight: bold;">üîç Filter:</label>
                <select id="instance-filter" style="margin-left: 5px; padding: 5px;">
                  <option value="all">All Instances</option>
                  <option value="bookmarked">Bookmarked Only</option>
                  <option value="tp">True Positives (Correct)</option>
                  <option value="fp">False Positives (Wrong Pred)</option>
                  <option value="fn">False Negatives (Missed)</option>
                  <option value="high-confidence">High Confidence (>0.8)</option>
                  <option value="low-confidence">Low Confidence (<0.5)</option>
                </select>
              </div>
              <div>
                <label style="font-weight: bold;">üìä Analysis:</label>
                <button id="confusion-analysis" style="margin-left: 5px; padding: 5px 10px; background: #3498db; color: white; border: none; border-radius: 3px;">Confusion Report</button>
              </div>
            </div>
            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee; font-size: 12px; color: #666;">
              <strong>üí° Usage:</strong> 
              ‚Ä¢ Hover over squares to see prediction scores across all classes via parallel coordinates
              ‚Ä¢ Click squares to bookmark important instances
              ‚Ä¢ Double-click for detailed analysis
              ‚Ä¢ Toggle polylines to see confusion patterns between classes
            </div>
          </div>
        </div>
    </div>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
    (() => {
      const raw_instances = [{"true_label": 1, "pred_label": 1, "pred_score": 0.7127380952380952}, {"true_label": 3, "pred_label": 3, "pred_score": 0.7918333333333334}, {"true_label": 1, "pred_label": 1, "pred_score": 0.4737301587301587}, {"true_label": 5, "pred_label": 5, "pred_score": 0.9333333333333335}, {"true_label": 0, "pred_label": 0, "pred_score": 0.9368333333333334}, {"true_label": 6, "pred_label": 6, "pred_score": 0.821}, {"true_label": 6, "pred_label": 6, "pred_score": 0.905}, {"true_label": 7, "pred_label": 7, "pred_score": 0.7845833333333333}, {"true_label": 4, "pred_label": 4, "pred_score": 0.9683333333333333}, {"true_label": 9, "pred_label": 9, "pred_score": 0.7946825396825398}, {"true_label": 3, "pred_label": 3, "pred_score": 0.8148333333333333}, {"true_label": 9, "pred_label": 9, "pred_score": 0.7238333333333332}, {"true_label": 7, "pred_label": 7, "pred_score": 0.9375}, {"true_label": 7, "pred_label": 7, "pred_score": 0.9611666666666667}, {"true_label": 6, "pred_label": 6, "pred_score": 0.6306666666666667}, {"true_label": 1, "pred_label": 1, "pred_score": 0.7073333333333331}, {"true_label": 5, "pred_label": 5, "pred_score": 0.5360833333333335}, {"true_label": 7, "pred_label": 7, "pred_score": 0.5429166666666667}, {"true_label": 3, "pred_label": 3, "pred_score": 0.9286666666666668}, {"true_label": 3, "pred_label": 3, "pred_score": 0.9064999999999999}, {"true_label": 9, "pred_label": 9, "pred_score": 0.3244444444444444}, {"true_label": 8, "pred_label": 8, "pred_score": 0.6659166666666667}, {"true_label": 5, "pred_label": 9, "pred_score": 0.2815000000000001}, {"true_label": 5, "pred_label": 5, "pred_score": 0.7069761904761905}, {"true_label": 4, "pred_label": 4, "pred_score": 0.955}, {"true_label": 4, "pred_label": 4, "pred_score": 0.9485000000000001}, {"true_label": 9, "pred_label": 9, "pred_score": 0.9199999999999998}, {"true_label": 3, "pred_label": 3, "pred_score": 0.943}, {"true_label": 2, "pred_label": 2, "pred_score": 0.7524999999999998}, {"true_label": 3, "pred_label": 3, "pred_score": 0.8238571428571428}, {"true_label": 6, "pred_label": 6, "pred_score": 0.9033333333333333}, {"true_label": 0, "pred_label": 0, "pred_score": 0.9625}, {"true_label": 2, "pred_label": 2, "pred_score": 0.5443333333333333}, {"true_label": 0, "pred_label": 0, "pred_score": 0.7697619047619046}, {"true_label": 4, "pred_label": 4, "pred_score": 0.9169444444444446}, {"true_label": 6, "pred_label": 6, "pred_score": 0.91}, {"true_label": 1, "pred_label": 1, "pred_score": 0.9043333333333332}, {"true_label": 8, "pred_label": 8, "pred_score": 0.36003571428571435}, {"true_label": 5, "pred_label": 5, "pred_score": 0.9416666666666665}, {"true_label": 5, "pred_label": 5, "pred_score": 0.40883333333333316}, {"true_label": 2, "pred_label": 2, "pred_score": 0.7453333333333333}, {"true_label": 3, "pred_label": 3, "pred_score": 0.6458095238095238}, {"true_label": 1, "pred_label": 1, "pred_score": 0.6863809523809523}, {"true_label": 3, "pred_label": 3, "pred_score": 0.7385238095238096}, {"true_label": 2, "pred_label": 2, "pred_score": 0.9423333333333334}, {"true_label": 6, "pred_label": 6, "pred_score": 0.9381666666666666}, {"true_label": 5, "pred_label": 5, "pred_score": 0.6461782106782107}, {"true_label": 8, "pred_label": 8, "pred_score": 0.5961904761904762}, {"true_label": 9, "pred_label": 7, "pred_score": 0.35660714285714284}, {"true_label": 6, "pred_label": 6, "pred_score": 0.9636666666666666}, {"true_label": 0, "pred_label": 0, "pred_score": 0.7531071428571429}, {"true_label": 4, "pred_label": 4, "pred_score": 0.7783333333333333}, {"true_label": 6, "pred_label": 6, "pred_score": 0.6233095238095239}, {"true_label": 5, "pred_label": 5, "pred_score": 0.4671309523809524}, {"true_label": 1, "pred_label": 1, "pred_score": 0.9580000000000001}, {"true_label": 6, "pred_label": 6, "pred_score": 0.8816666666666667}, {"true_label": 6, "pred_label": 6, "pred_score": 0.99}, {"true_label": 6, "pred_label": 6, "pred_score": 0.9115000000000001}, {"true_label": 2, "pred_label": 2, "pred_score": 0.8041190476190475}, {"true_label": 3, "pred_label": 3, "pred_score": 0.7961190476190477}, {"true_label": 1, "pred_label": 1, "pred_score": 0.5117857142857143}, {"true_label": 2, "pred_label": 2, "pred_score": 0.8695833333333333}, {"true_label": 9, "pred_label": 9, "pred_score": 0.5771666666666666}, {"true_label": 9, "pred_label": 9, "pred_score": 0.7888333333333334}, {"true_label": 4, "pred_label": 4, "pred_score": 0.8741666666666668}, {"true_label": 6, "pred_label": 6, "pred_score": 0.99}, {"true_label": 1, "pred_label": 1, "pred_score": 0.7014563492063494}, {"true_label": 5, "pred_label": 5, "pred_score": 0.7324166666666667}, {"true_label": 0, "pred_label": 0, "pred_score": 0.9634999999999999}, {"true_label": 9, "pred_label": 9, "pred_score": 0.4315833333333334}, {"true_label": 9, "pred_label": 9, "pred_score": 0.9002380952380953}, {"true_label": 8, "pred_label": 8, "pred_score": 0.5345}, {"true_label": 4, "pred_label": 4, "pred_score": 0.772547619047619}, {"true_label": 7, "pred_label": 7, "pred_score": 0.9366666666666668}, {"true_label": 7, "pred_label": 7, "pred_score": 0.7971785714285714}, {"true_label": 5, "pred_label": 9, "pred_score": 0.4268730158730159}, {"true_label": 0, "pred_label": 0, "pred_score": 0.9484285714285715}, {"true_label": 0, "pred_label": 0, "pred_score": 0.8390000000000001}, {"true_label": 4, "pred_label": 4, "pred_score": 0.8963333333333332}, {"true_label": 9, "pred_label": 9, "pred_score": 0.7293333333333333}, {"true_label": 5, "pred_label": 5, "pred_score": 0.74575}, {"true_label": 4, "pred_label": 4, "pred_score": 0.8375}, {"true_label": 1, "pred_label": 1, "pred_score": 0.40808333333333335}, {"true_label": 9, "pred_label": 9, "pred_score": 0.9486666666666665}, {"true_label": 0, "pred_label": 0, "pred_score": 0.948095238095238}, {"true_label": 0, "pred_label": 0, "pred_score": 0.6817777777777778}, {"true_label": 5, "pred_label": 5, "pred_score": 0.8394761904761904}, {"true_label": 6, "pred_label": 6, "pred_score": 1.0}, {"true_label": 5, "pred_label": 5, "pred_score": 0.9466666666666668}, {"true_label": 7, "pred_label": 7, "pred_score": 0.7490000000000001}, {"true_label": 3, "pred_label": 3, "pred_score": 0.9675}, {"true_label": 5, "pred_label": 5, "pred_score": 0.9224523809523809}, {"true_label": 3, "pred_label": 3, "pred_score": 0.8508055555555555}, {"true_label": 1, "pred_label": 1, "pred_score": 0.41225}, {"true_label": 5, "pred_label": 5, "pred_score": 0.6508333333333334}, {"true_label": 9, "pred_label": 3, "pred_score": 0.3282380952380952}, {"true_label": 2, "pred_label": 2, "pred_score": 0.9701666666666666}, {"true_label": 3, "pred_label": 3, "pred_score": 0.4668333333333334}, {"true_label": 9, "pred_label": 9, "pred_score": 0.8368571428571429}, {"true_label": 7, "pred_label": 7, "pred_score": 0.4454087301587302}, {"true_label": 4, "pred_label": 4, "pred_score": 0.91}, {"true_label": 0, "pred_label": 0, "pred_score": 0.6401111111111112}, {"true_label": 0, "pred_label": 0, "pred_score": 0.9365952380952379}, {"true_label": 9, "pred_label": 9, "pred_score": 0.8384761904761904}, {"true_label": 2, "pred_label": 2, "pred_score": 0.4147619047619047}, {"true_label": 7, "pred_label": 7, "pred_score": 0.6278333333333332}, {"true_label": 3, "pred_label": 3, "pred_score": 0.6239960317460317}, {"true_label": 1, "pred_label": 1, "pred_score": 0.7095}, {"true_label": 4, "pred_label": 4, "pred_score": 0.9875}, {"true_label": 9, "pred_label": 9, "pred_score": 0.8631666666666665}, {"true_label": 3, "pred_label": 3, "pred_score": 0.7593809523809525}, {"true_label": 8, "pred_label": 8, "pred_score": 0.43599999999999994}, {"true_label": 2, "pred_label": 2, "pred_score": 0.965}, {"true_label": 5, "pred_label": 5, "pred_score": 0.7944999999999999}, {"true_label": 1, "pred_label": 1, "pred_score": 0.7971190476190475}, {"true_label": 1, "pred_label": 1, "pred_score": 0.6296666666666667}, {"true_label": 6, "pred_label": 6, "pred_score": 0.937}, {"true_label": 9, "pred_label": 9, "pred_score": 0.4850119047619048}, {"true_label": 4, "pred_label": 4, "pred_score": 0.97}, {"true_label": 3, "pred_label": 3, "pred_score": 0.8389393939393939}, {"true_label": 7, "pred_label": 7, "pred_score": 0.9088095238095236}, {"true_label": 1, "pred_label": 1, "pred_score": 0.6460714285714286}, {"true_label": 8, "pred_label": 8, "pred_score": 0.4666428571428572}, {"true_label": 1, "pred_label": 1, "pred_score": 0.5651666666666667}, {"true_label": 9, "pred_label": 9, "pred_score": 0.5971904761904763}, {"true_label": 7, "pred_label": 7, "pred_score": 0.9483333333333333}, {"true_label": 9, "pred_label": 9, "pred_score": 0.92175}, {"true_label": 0, "pred_label": 0, "pred_score": 0.8879761904761905}, {"true_label": 3, "pred_label": 3, "pred_score": 0.8862857142857143}, {"true_label": 2, "pred_label": 2, "pred_score": 0.890904761904762}, {"true_label": 7, "pred_label": 7, "pred_score": 0.9266666666666667}, {"true_label": 7, "pred_label": 7, "pred_score": 0.9229999999999999}, {"true_label": 2, "pred_label": 2, "pred_score": 0.6471428571428572}, {"true_label": 4, "pred_label": 4, "pred_score": 0.4895714285714285}, {"true_label": 0, "pred_label": 0, "pred_score": 0.8896666666666667}, {"true_label": 8, "pred_label": 8, "pred_score": 0.44451190476190483}, {"true_label": 4, "pred_label": 4, "pred_score": 0.6472182539682538}, {"true_label": 8, "pred_label": 1, "pred_score": 0.4911904761904762}, {"true_label": 5, "pred_label": 5, "pred_score": 0.8385808080808081}, {"true_label": 7, "pred_label": 7, "pred_score": 0.910845238095238}, {"true_label": 2, "pred_label": 2, "pred_score": 0.9365000000000001}, {"true_label": 4, "pred_label": 4, "pred_score": 0.9817857142857143}, {"true_label": 2, "pred_label": 2, "pred_score": 0.7305833333333334}, {"true_label": 9, "pred_label": 9, "pred_score": 0.83}, {"true_label": 5, "pred_label": 5, "pred_score": 0.8596666666666666}, {"true_label": 9, "pred_label": 9, "pred_score": 0.42702380952380947}, {"true_label": 5, "pred_label": 5, "pred_score": 0.7320714285714286}, {"true_label": 4, "pred_label": 4, "pred_score": 0.4652380952380952}, {"true_label": 4, "pred_label": 4, "pred_score": 0.9725}, {"true_label": 2, "pred_label": 2, "pred_score": 0.935}, {"true_label": 0, "pred_label": 0, "pred_score": 0.99}, {"true_label": 3, "pred_label": 3, "pred_score": 0.7410952380952383}, {"true_label": 3, "pred_label": 3, "pred_score": 0.7126666666666668}, {"true_label": 7, "pred_label": 7, "pred_score": 0.9349880952380952}, {"true_label": 2, "pred_label": 2, "pred_score": 0.5394007936507936}, {"true_label": 5, "pred_label": 5, "pred_score": 0.4729166666666667}, {"true_label": 1, "pred_label": 1, "pred_score": 0.5656666666666667}, {"true_label": 5, "pred_label": 5, "pred_score": 0.8028333333333333}, {"true_label": 1, "pred_label": 1, "pred_score": 0.8975}, {"true_label": 0, "pred_label": 0, "pred_score": 0.8018730158730157}, {"true_label": 6, "pred_label": 6, "pred_score": 0.7833095238095238}, {"true_label": 7, "pred_label": 7, "pred_score": 0.7328333333333333}, {"true_label": 7, "pred_label": 7, "pred_score": 0.6380238095238095}, {"true_label": 3, "pred_label": 3, "pred_score": 0.8005476190476191}, {"true_label": 2, "pred_label": 1, "pred_score": 0.25871428571428573}, {"true_label": 3, "pred_label": 3, "pred_score": 0.77325}, {"true_label": 1, "pred_label": 1, "pred_score": 0.857654761904762}, {"true_label": 0, "pred_label": 0, "pred_score": 0.7365476190476191}, {"true_label": 7, "pred_label": 7, "pred_score": 0.9541666666666667}, {"true_label": 3, "pred_label": 3, "pred_score": 0.8457857142857144}, {"true_label": 0, "pred_label": 0, "pred_score": 0.9858333333333335}, {"true_label": 7, "pred_label": 7, "pred_score": 0.8698888888888889}, {"true_label": 4, "pred_label": 4, "pred_score": 0.8945000000000001}, {"true_label": 9, "pred_label": 9, "pred_score": 0.7115}, {"true_label": 2, "pred_label": 2, "pred_score": 0.9460000000000001}, {"true_label": 5, "pred_label": 5, "pred_score": 0.7191666666666667}, {"true_label": 3, "pred_label": 3, "pred_score": 0.9089285714285714}, {"true_label": 0, "pred_label": 0, "pred_score": 0.9813333333333333}, {"true_label": 0, "pred_label": 0, "pred_score": 1.0}, {"true_label": 9, "pred_label": 9, "pred_score": 0.7922380952380952}, {"true_label": 5, "pred_label": 5, "pred_score": 0.72}, {"true_label": 1, "pred_label": 1, "pred_score": 0.31183333333333335}, {"true_label": 7, "pred_label": 7, "pred_score": 0.702202380952381}, {"true_label": 6, "pred_label": 6, "pred_score": 0.9566666666666667}, {"true_label": 5, "pred_label": 5, "pred_score": 0.7069047619047619}, {"true_label": 3, "pred_label": 1, "pred_score": 0.24047619047619048}, {"true_label": 4, "pred_label": 4, "pred_score": 0.9491666666666666}, {"true_label": 6, "pred_label": 6, "pred_score": 0.8684999999999999}, {"true_label": 0, "pred_label": 0, "pred_score": 0.8711666666666666}, {"true_label": 6, "pred_label": 6, "pred_score": 0.9166666666666667}, {"true_label": 6, "pred_label": 6, "pred_score": 0.9625}, {"true_label": 3, "pred_label": 3, "pred_score": 0.2325714285714286}, {"true_label": 4, "pred_label": 4, "pred_score": 0.9758333333333333}, {"true_label": 6, "pred_label": 6, "pred_score": 0.8987777777777777}, {"true_label": 2, "pred_label": 2, "pred_score": 0.6229166666666667}, {"true_label": 1, "pred_label": 1, "pred_score": 0.48751190476190476}, {"true_label": 6, "pred_label": 4, "pred_score": 0.25439285714285714}, {"true_label": 9, "pred_label": 9, "pred_score": 0.7332222222222222}, {"true_label": 7, "pred_label": 7, "pred_score": 0.95625}, {"true_label": 4, "pred_label": 4, "pred_score": 0.8041666666666667}, {"true_label": 3, "pred_label": 3, "pred_score": 0.9694047619047619}, {"true_label": 4, "pred_label": 4, "pred_score": 0.9575}, {"true_label": 2, "pred_label": 2, "pred_score": 0.9584999999999999}, {"true_label": 4, "pred_label": 4, "pred_score": 0.9575}, {"true_label": 8, "pred_label": 8, "pred_score": 0.6796666666666666}, {"true_label": 0, "pred_label": 0, "pred_score": 0.8164285714285713}, {"true_label": 3, "pred_label": 3, "pred_score": 0.5224047619047618}, {"true_label": 1, "pred_label": 1, "pred_score": 0.39116666666666666}, {"true_label": 2, "pred_label": 2, "pred_score": 0.8855}, {"true_label": 4, "pred_label": 4, "pred_score": 0.9331666666666666}, {"true_label": 7, "pred_label": 7, "pred_score": 0.9754166666666667}, {"true_label": 2, "pred_label": 2, "pred_score": 0.7286666666666668}, {"true_label": 0, "pred_label": 0, "pred_score": 0.9833333333333333}, {"true_label": 8, "pred_label": 8, "pred_score": 0.7148333333333333}, {"true_label": 8, "pred_label": 8, "pred_score": 0.7076428571428572}, {"true_label": 6, "pred_label": 6, "pred_score": 0.9466666666666668}, {"true_label": 1, "pred_label": 1, "pred_score": 0.8928928571428572}, {"true_label": 8, "pred_label": 8, "pred_score": 0.768452380952381}, {"true_label": 4, "pred_label": 4, "pred_score": 0.97}, {"true_label": 5, "pred_label": 5, "pred_score": 0.8367857142857144}, {"true_label": 1, "pred_label": 1, "pred_score": 0.7347499999999999}, {"true_label": 0, "pred_label": 0, "pred_score": 0.9684999999999999}, {"true_label": 2, "pred_label": 2, "pred_score": 0.4748571428571429}, {"true_label": 8, "pred_label": 8, "pred_score": 0.5994999999999999}, {"true_label": 4, "pred_label": 4, "pred_score": 0.7877500000000001}, {"true_label": 2, "pred_label": 2, "pred_score": 0.94}, {"true_label": 0, "pred_label": 0, "pred_score": 0.9019047619047619}, {"true_label": 1, "pred_label": 1, "pred_score": 0.8647619047619046}, {"true_label": 6, "pred_label": 6, "pred_score": 0.42758730158730157}, {"true_label": 8, "pred_label": 8, "pred_score": 0.6995238095238094}, {"true_label": 8, "pred_label": 8, "pred_score": 0.2512619047619048}, {"true_label": 5, "pred_label": 5, "pred_score": 0.6476428571428571}, {"true_label": 8, "pred_label": 8, "pred_score": 0.6916785714285715}, {"true_label": 3, "pred_label": 3, "pred_score": 0.7393333333333334}, {"true_label": 1, "pred_label": 1, "pred_score": 0.7668571428571428}, {"true_label": 9, "pred_label": 9, "pred_score": 0.8395714285714285}, {"true_label": 0, "pred_label": 0, "pred_score": 0.976}, {"true_label": 4, "pred_label": 4, "pred_score": 0.6657619047619048}, {"true_label": 6, "pred_label": 6, "pred_score": 0.95}, {"true_label": 2, "pred_label": 2, "pred_score": 0.9667857142857144}, {"true_label": 9, "pred_label": 8, "pred_score": 0.3544166666666666}, {"true_label": 6, "pred_label": 6, "pred_score": 0.7111428571428572}, {"true_label": 7, "pred_label": 7, "pred_score": 0.8691666666666668}, {"true_label": 1, "pred_label": 1, "pred_score": 0.3644523809523809}, {"true_label": 0, "pred_label": 0, "pred_score": 1.0}, {"true_label": 4, "pred_label": 4, "pred_score": 0.8498095238095238}, {"true_label": 6, "pred_label": 6, "pred_score": 0.857904761904762}, {"true_label": 0, "pred_label": 4, "pred_score": 0.4645595238095238}, {"true_label": 8, "pred_label": 8, "pred_score": 0.5168571428571429}, {"true_label": 2, "pred_label": 0, "pred_score": 0.3425}, {"true_label": 8, "pred_label": 8, "pred_score": 0.6279841269841271}, {"true_label": 9, "pred_label": 9, "pred_score": 0.7836666666666666}, {"true_label": 1, "pred_label": 1, "pred_score": 0.3727499999999999}, {"true_label": 2, "pred_label": 2, "pred_score": 0.5096984126984128}, {"true_label": 3, "pred_label": 3, "pred_score": 0.7841190476190476}, {"true_label": 9, "pred_label": 9, "pred_score": 0.49266666666666664}, {"true_label": 4, "pred_label": 4, "pred_score": 0.5505}, {"true_label": 7, "pred_label": 7, "pred_score": 0.951}, {"true_label": 5, "pred_label": 5, "pred_score": 0.7147619047619045}, {"true_label": 7, "pred_label": 7, "pred_score": 0.4198333333333333}, {"true_label": 2, "pred_label": 2, "pred_score": 0.9675}, {"true_label": 9, "pred_label": 9, "pred_score": 0.9603809523809523}, {"true_label": 4, "pred_label": 4, "pred_score": 0.3892857142857144}, {"true_label": 6, "pred_label": 6, "pred_score": 0.7416349206349205}, {"true_label": 2, "pred_label": 2, "pred_score": 0.827095238095238}, {"true_label": 8, "pred_label": 8, "pred_score": 0.49875}, {"true_label": 7, "pred_label": 7, "pred_score": 0.8028333333333333}, {"true_label": 5, "pred_label": 5, "pred_score": 0.8568333333333333}, {"true_label": 8, "pred_label": 8, "pred_score": 0.5195}, {"true_label": 8, "pred_label": 8, "pred_score": 0.66}, {"true_label": 0, "pred_label": 0, "pred_score": 0.97}, {"true_label": 3, "pred_label": 3, "pred_score": 0.5494722222222223}, {"true_label": 2, "pred_label": 2, "pred_score": 0.5363888888888888}, {"true_label": 3, "pred_label": 3, "pred_score": 0.8022380952380952}, {"true_label": 1, "pred_label": 1, "pred_score": 0.824654761904762}, {"true_label": 2, "pred_label": 2, "pred_score": 0.3774729437229437}, {"true_label": 6, "pred_label": 6, "pred_score": 0.8153333333333335}, {"true_label": 8, "pred_label": 8, "pred_score": 0.5274880952380951}, {"true_label": 5, "pred_label": 5, "pred_score": 0.9533333333333333}, {"true_label": 2, "pred_label": 2, "pred_score": 0.9796666666666667}, {"true_label": 8, "pred_label": 8, "pred_score": 0.469297619047619}, {"true_label": 3, "pred_label": 3, "pred_score": 0.8742857142857143}, {"true_label": 1, "pred_label": 1, "pred_score": 0.7461309523809524}, {"true_label": 3, "pred_label": 3, "pred_score": 0.785}, {"true_label": 0, "pred_label": 0, "pred_score": 0.978}, {"true_label": 5, "pred_label": 5, "pred_score": 0.9083333333333333}, {"true_label": 3, "pred_label": 3, "pred_score": 0.26123809523809527}, {"true_label": 1, "pred_label": 1, "pred_score": 0.5723333333333334}, {"true_label": 7, "pred_label": 7, "pred_score": 0.9233333333333333}, {"true_label": 2, "pred_label": 2, "pred_score": 0.7544015151515151}, {"true_label": 0, "pred_label": 0, "pred_score": 0.8688095238095238}, {"true_label": 1, "pred_label": 1, "pred_score": 0.5511666666666666}, {"true_label": 0, "pred_label": 0, "pred_score": 0.7695833333333333}, {"true_label": 9, "pred_label": 9, "pred_score": 0.7117460317460318}, {"true_label": 7, "pred_label": 7, "pred_score": 0.9607142857142857}, {"true_label": 9, "pred_label": 9, "pred_score": 0.9691071428571427}, {"true_label": 2, "pred_label": 2, "pred_score": 0.9975}, {"true_label": 3, "pred_label": 3, "pred_score": 0.9353571428571428}, {"true_label": 5, "pred_label": 5, "pred_score": 0.50725}, {"true_label": 3, "pred_label": 3, "pred_score": 0.442}, {"true_label": 0, "pred_label": 0, "pred_score": 0.9814285714285714}, {"true_label": 2, "pred_label": 2, "pred_score": 0.3443095238095238}, {"true_label": 9, "pred_label": 9, "pred_score": 0.43957142857142856}, {"true_label": 1, "pred_label": 1, "pred_score": 0.9335000000000001}, {"true_label": 6, "pred_label": 6, "pred_score": 0.8992380952380951}, {"true_label": 1, "pred_label": 1, "pred_score": 0.5267142857142857}, {"true_label": 9, "pred_label": 9, "pred_score": 0.527}, {"true_label": 5, "pred_label": 5, "pred_score": 0.78425}, {"true_label": 5, "pred_label": 5, "pred_score": 0.985}, {"true_label": 5, "pred_label": 5, "pred_score": 0.7715808080808082}, {"true_label": 4, "pred_label": 4, "pred_score": 0.9675}, {"true_label": 7, "pred_label": 7, "pred_score": 0.7888333333333334}, {"true_label": 7, "pred_label": 7, "pred_score": 0.8445833333333332}, {"true_label": 9, "pred_label": 9, "pred_score": 0.7858571428571429}, {"true_label": 3, "pred_label": 3, "pred_score": 0.8375}, {"true_label": 6, "pred_label": 6, "pred_score": 0.9466666666666668}, {"true_label": 9, "pred_label": 9, "pred_score": 0.8123690476190475}, {"true_label": 4, "pred_label": 4, "pred_score": 0.9404761904761905}, {"true_label": 6, "pred_label": 6, "pred_score": 0.97}, {"true_label": 1, "pred_label": 1, "pred_score": 0.7846666666666665}, {"true_label": 8, "pred_label": 8, "pred_score": 0.7857023809523809}, {"true_label": 5, "pred_label": 5, "pred_score": 0.7589047619047621}, {"true_label": 3, "pred_label": 3, "pred_score": 0.929}, {"true_label": 7, "pred_label": 7, "pred_score": 0.7557738095238097}, {"true_label": 0, "pred_label": 0, "pred_score": 0.8996666666666667}, {"true_label": 2, "pred_label": 2, "pred_score": 0.7889166666666667}, {"true_label": 2, "pred_label": 2, "pred_score": 0.7163452380952381}, {"true_label": 6, "pred_label": 6, "pred_score": 0.8888333333333334}, {"true_label": 4, "pred_label": 4, "pred_score": 0.6835}, {"true_label": 8, "pred_label": 8, "pred_score": 0.4965119047619047}, {"true_label": 7, "pred_label": 7, "pred_score": 0.9289166666666666}, {"true_label": 9, "pred_label": 9, "pred_score": 0.7805833333333334}, {"true_label": 2, "pred_label": 2, "pred_score": 0.7290000000000001}, {"true_label": 0, "pred_label": 0, "pred_score": 0.9020833333333335}, {"true_label": 8, "pred_label": 8, "pred_score": 0.588452380952381}, {"true_label": 4, "pred_label": 4, "pred_score": 0.5887261904761903}, {"true_label": 6, "pred_label": 6, "pred_score": 0.8553333333333333}, {"true_label": 7, "pred_label": 7, "pred_score": 0.7061190476190475}, {"true_label": 3, "pred_label": 3, "pred_score": 0.768690476190476}, {"true_label": 1, "pred_label": 1, "pred_score": 0.4769642857142857}, {"true_label": 5, "pred_label": 5, "pred_score": 0.9855357142857143}, {"true_label": 4, "pred_label": 1, "pred_score": 0.37666666666666665}, {"true_label": 7, "pred_label": 7, "pred_score": 0.7565000000000001}, {"true_label": 2, "pred_label": 2, "pred_score": 0.942857142857143}, {"true_label": 4, "pred_label": 4, "pred_score": 0.8254761904761905}, {"true_label": 9, "pred_label": 9, "pred_score": 0.38966666666666677}, {"true_label": 4, "pred_label": 4, "pred_score": 0.8166666666666665}, {"true_label": 2, "pred_label": 2, "pred_score": 0.9055}, {"true_label": 1, "pred_label": 1, "pred_score": 0.9388333333333333}, {"true_label": 4, "pred_label": 4, "pred_score": 0.9447142857142856}, {"true_label": 7, "pred_label": 7, "pred_score": 0.8990714285714284}, {"true_label": 1, "pred_label": 1, "pred_score": 0.6798095238095239}, {"true_label": 7, "pred_label": 7, "pred_score": 0.931607142857143}, {"true_label": 2, "pred_label": 2, "pred_score": 0.8571428571428571}, {"true_label": 9, "pred_label": 9, "pred_score": 0.4234166666666668}, {"true_label": 2, "pred_label": 2, "pred_score": 0.9486666666666668}, {"true_label": 6, "pred_label": 6, "pred_score": 0.6044166666666667}, {"true_label": 7, "pred_label": 7, "pred_score": 0.8488809523809523}, {"true_label": 3, "pred_label": 3, "pred_score": 0.7381666666666666}, {"true_label": 7, "pred_label": 7, "pred_score": 0.5323257575757576}, {"true_label": 3, "pred_label": 3, "pred_score": 0.48104761904761917}, {"true_label": 2, "pred_label": 2, "pred_score": 0.5377857142857143}, {"true_label": 9, "pred_label": 9, "pred_score": 0.7438214285714286}, {"true_label": 9, "pred_label": 7, "pred_score": 0.36330158730158724}, {"true_label": 8, "pred_label": 8, "pred_score": 0.41333333333333333}, {"true_label": 8, "pred_label": 8, "pred_score": 0.50625}, {"true_label": 9, "pred_label": 9, "pred_score": 0.966}, {"true_label": 4, "pred_label": 4, "pred_score": 0.6715952380952381}, {"true_label": 1, "pred_label": 1, "pred_score": 0.7560000000000001}, {"true_label": 7, "pred_label": 7, "pred_score": 0.7802777777777778}, {"true_label": 9, "pred_label": 9, "pred_score": 0.6277619047619047}, {"true_label": 4, "pred_label": 4, "pred_score": 0.8719246031746032}, {"true_label": 8, "pred_label": 8, "pred_score": 0.6076428571428572}, {"true_label": 9, "pred_label": 7, "pred_score": 0.2722261904761904}, {"true_label": 8, "pred_label": 8, "pred_score": 0.7891666666666666}, {"true_label": 8, "pred_label": 8, "pred_score": 0.7592532467532468}, {"true_label": 0, "pred_label": 4, "pred_score": 0.2798888888888889}, {"true_label": 1, "pred_label": 1, "pred_score": 0.4988690476190476}, {"true_label": 3, "pred_label": 3, "pred_score": 0.9741666666666667}, {"true_label": 0, "pred_label": 0, "pred_score": 0.6758333333333334}, {"true_label": 0, "pred_label": 0, "pred_score": 0.9525}, {"true_label": 0, "pred_label": 0, "pred_score": 0.4336904761904762}, {"true_label": 9, "pred_label": 9, "pred_score": 0.9289761904761906}, {"true_label": 6, "pred_label": 6, "pred_score": 0.9541666666666667}, {"true_label": 8, "pred_label": 8, "pred_score": 0.697452380952381}, {"true_label": 4, "pred_label": 4, "pred_score": 0.7879761904761904}, {"true_label": 7, "pred_label": 7, "pred_score": 0.9629166666666665}, {"true_label": 0, "pred_label": 0, "pred_score": 0.8625714285714284}, {"true_label": 7, "pred_label": 7, "pred_score": 0.8133571428571429}, {"true_label": 3, "pred_label": 3, "pred_score": 0.96}, {"true_label": 1, "pred_label": 1, "pred_score": 0.9486111111111112}, {"true_label": 8, "pred_label": 8, "pred_score": 0.5336547619047619}, {"true_label": 5, "pred_label": 5, "pred_score": 0.7868333333333333}, {"true_label": 7, "pred_label": 7, "pred_score": 0.807}, {"true_label": 0, "pred_label": 0, "pred_score": 0.9175}, {"true_label": 9, "pred_label": 9, "pred_score": 0.4373015873015873}, {"true_label": 5, "pred_label": 5, "pred_score": 0.731904761904762}, {"true_label": 0, "pred_label": 0, "pred_score": 0.9141666666666667}, {"true_label": 6, "pred_label": 6, "pred_score": 0.5124523809523809}, {"true_label": 9, "pred_label": 9, "pred_score": 0.8084166666666668}, {"true_label": 4, "pred_label": 4, "pred_score": 0.8413333333333333}, {"true_label": 7, "pred_label": 7, "pred_score": 0.8499285714285715}, {"true_label": 5, "pred_label": 5, "pred_score": 0.8827380952380952}, {"true_label": 6, "pred_label": 6, "pred_score": 0.8822857142857142}, {"true_label": 1, "pred_label": 1, "pred_score": 0.8775}, {"true_label": 5, "pred_label": 5, "pred_score": 0.935142857142857}, {"true_label": 3, "pred_label": 3, "pred_score": 0.6818888888888889}, {"true_label": 4, "pred_label": 4, "pred_score": 0.5508333333333333}, {"true_label": 6, "pred_label": 6, "pred_score": 0.9825}, {"true_label": 5, "pred_label": 5, "pred_score": 0.7900833333333332}, {"true_label": 1, "pred_label": 1, "pred_score": 0.384452380952381}, {"true_label": 6, "pred_label": 6, "pred_score": 0.9866666666666667}, {"true_label": 8, "pred_label": 8, "pred_score": 0.5091190476190476}, {"true_label": 7, "pred_label": 7, "pred_score": 0.7524682539682539}, {"true_label": 0, "pred_label": 0, "pred_score": 0.7313333333333333}, {"true_label": 8, "pred_label": 8, "pred_score": 0.6240833333333332}, {"true_label": 3, "pred_label": 3, "pred_score": 0.9202499999999999}, {"true_label": 6, "pred_label": 6, "pred_score": 0.6285000000000001}, {"true_label": 5, "pred_label": 5, "pred_score": 0.36958333333333326}, {"true_label": 0, "pred_label": 0, "pred_score": 0.955}, {"true_label": 3, "pred_label": 3, "pred_score": 0.5585436507936508}, {"true_label": 2, "pred_label": 2, "pred_score": 0.9780000000000001}, {"true_label": 3, "pred_label": 3, "pred_score": 0.8861666666666668}, {"true_label": 5, "pred_label": 5, "pred_score": 0.745}, {"true_label": 6, "pred_label": 6, "pred_score": 0.9581666666666666}, {"true_label": 4, "pred_label": 4, "pred_score": 0.8427500000000001}, {"true_label": 5, "pred_label": 5, "pred_score": 0.7801666666666667}, {"true_label": 2, "pred_label": 2, "pred_score": 0.7154285714285714}, {"true_label": 8, "pred_label": 8, "pred_score": 0.5330357142857143}, {"true_label": 6, "pred_label": 6, "pred_score": 0.9237857142857142}, {"true_label": 4, "pred_label": 4, "pred_score": 0.6768690476190478}, {"true_label": 1, "pred_label": 1, "pred_score": 0.84}, {"true_label": 8, "pred_label": 8, "pred_score": 0.5588333333333333}, {"true_label": 6, "pred_label": 6, "pred_score": 0.9465}, {"true_label": 6, "pred_label": 6, "pred_score": 0.42076190476190467}, {"true_label": 2, "pred_label": 2, "pred_score": 0.8696666666666667}, {"true_label": 5, "pred_label": 5, "pred_score": 0.35424999999999995}, {"true_label": 4, "pred_label": 4, "pred_score": 0.21269047619047615}, {"true_label": 8, "pred_label": 8, "pred_score": 0.7716587301587302}, {"true_label": 9, "pred_label": 9, "pred_score": 0.9229999999999999}, {"true_label": 1, "pred_label": 1, "pred_score": 0.8611666666666666}, {"true_label": 7, "pred_label": 7, "pred_score": 0.568095238095238}, {"true_label": 3, "pred_label": 3, "pred_score": 0.6600476190476191}, {"true_label": 2, "pred_label": 2, "pred_score": 0.7225}, {"true_label": 3, "pred_label": 3, "pred_score": 0.6052698412698413}, {"true_label": 4, "pred_label": 4, "pred_score": 0.6168809523809524}, {"true_label": 7, "pred_label": 7, "pred_score": 0.9911111111111112}, {"true_label": 1, "pred_label": 1, "pred_score": 0.6225952380952382}, {"true_label": 1, "pred_label": 1, "pred_score": 0.7479166666666667}, {"true_label": 4, "pred_label": 4, "pred_score": 0.9425}, {"true_label": 8, "pred_label": 1, "pred_score": 0.5578928571428572}, {"true_label": 8, "pred_label": 1, "pred_score": 0.39766666666666667}, {"true_label": 6, "pred_label": 6, "pred_score": 0.893654761904762}, {"true_label": 2, "pred_label": 2, "pred_score": 0.9605}, {"true_label": 3, "pred_label": 3, "pred_score": 0.9663333333333334}, {"true_label": 6, "pred_label": 6, "pred_score": 0.6878928571428571}, {"true_label": 1, "pred_label": 1, "pred_score": 0.6198214285714285}, {"true_label": 7, "pred_label": 7, "pred_score": 0.9393333333333332}, {"true_label": 8, "pred_label": 8, "pred_score": 0.845}, {"true_label": 8, "pred_label": 8, "pred_score": 0.5533333333333333}, {"true_label": 4, "pred_label": 4, "pred_score": 0.7530238095238095}, {"true_label": 0, "pred_label": 0, "pred_score": 0.8408095238095237}, {"true_label": 6, "pred_label": 6, "pred_score": 0.9420000000000001}, {"true_label": 8, "pred_label": 8, "pred_score": 0.8934761904761903}, {"true_label": 5, "pred_label": 5, "pred_score": 0.6270833333333334}, {"true_label": 2, "pred_label": 2, "pred_score": 0.670401515151515}, {"true_label": 3, "pred_label": 3, "pred_score": 0.44758333333333317}, {"true_label": 2, "pred_label": 2, "pred_score": 0.8251666666666665}, {"true_label": 9, "pred_label": 9, "pred_score": 0.6152142857142857}, {"true_label": 0, "pred_label": 0, "pred_score": 0.8582857142857143}, {"true_label": 5, "pred_label": 5, "pred_score": 0.5445833333333333}, {"true_label": 0, "pred_label": 0, "pred_score": 0.90575}, {"true_label": 4, "pred_label": 4, "pred_score": 0.965}, {"true_label": 7, "pred_label": 7, "pred_score": 0.4426111111111112}, {"true_label": 1, "pred_label": 1, "pred_score": 0.7209166666666667}, {"true_label": 5, "pred_label": 5, "pred_score": 0.6603333333333333}, {"true_label": 0, "pred_label": 0, "pred_score": 0.6979047619047618}, {"true_label": 2, "pred_label": 2, "pred_score": 0.9633333333333333}, {"true_label": 6, "pred_label": 6, "pred_score": 0.99}, {"true_label": 0, "pred_label": 0, "pred_score": 0.98}, {"true_label": 0, "pred_label": 0, "pred_score": 0.8758333333333335}, {"true_label": 3, "pred_label": 3, "pred_score": 0.97}, {"true_label": 1, "pred_label": 1, "pred_score": 0.5471666666666667}, {"true_label": 8, "pred_label": 8, "pred_score": 0.539595238095238}, {"true_label": 6, "pred_label": 6, "pred_score": 0.9255}, {"true_label": 7, "pred_label": 7, "pred_score": 0.8998333333333332}, {"true_label": 7, "pred_label": 7, "pred_score": 0.5716666666666667}, {"true_label": 6, "pred_label": 6, "pred_score": 0.98}, {"true_label": 5, "pred_label": 5, "pred_score": 0.5577500000000001}, {"true_label": 0, "pred_label": 0, "pred_score": 0.8761785714285715}, {"true_label": 1, "pred_label": 1, "pred_score": 0.8275000000000001}, {"true_label": 8, "pred_label": 8, "pred_score": 0.789202380952381}, {"true_label": 3, "pred_label": 3, "pred_score": 0.4978333333333333}, {"true_label": 8, "pred_label": 7, "pred_score": 0.24157142857142855}, {"true_label": 9, "pred_label": 9, "pred_score": 0.7509603174603174}, {"true_label": 9, "pred_label": 9, "pred_score": 0.8044642857142857}, {"true_label": 5, "pred_label": 5, "pred_score": 0.8223333333333334}, {"true_label": 7, "pred_label": 7, "pred_score": 0.5621190476190477}, {"true_label": 8, "pred_label": 8, "pred_score": 0.3348333333333333}, {"true_label": 3, "pred_label": 3, "pred_score": 0.730095238095238}, {"true_label": 9, "pred_label": 8, "pred_score": 0.2871190476190476}, {"true_label": 7, "pred_label": 7, "pred_score": 0.7998809523809524}, {"true_label": 3, "pred_label": 3, "pred_score": 0.6920000000000001}, {"true_label": 8, "pred_label": 8, "pred_score": 0.8107500000000001}, {"true_label": 6, "pred_label": 6, "pred_score": 0.9608333333333334}, {"true_label": 5, "pred_label": 5, "pred_score": 0.688112554112554}, {"true_label": 5, "pred_label": 5, "pred_score": 0.8019047619047618}, {"true_label": 5, "pred_label": 5, "pred_score": 0.7876428571428572}, {"true_label": 2, "pred_label": 2, "pred_score": 0.8199166666666664}, {"true_label": 9, "pred_label": 9, "pred_score": 0.7089166666666666}, {"true_label": 8, "pred_label": 8, "pred_score": 0.7407738095238097}, {"true_label": 0, "pred_label": 0, "pred_score": 0.7669047619047618}, {"true_label": 9, "pred_label": 9, "pred_score": 0.8641666666666667}, {"true_label": 0, "pred_label": 0, "pred_score": 0.9440000000000001}, {"true_label": 4, "pred_label": 4, "pred_score": 0.5291428571428571}, {"true_label": 7, "pred_label": 7, "pred_score": 0.8126666666666666}, {"true_label": 1, "pred_label": 1, "pred_score": 0.7671111111111111}, {"true_label": 8, "pred_label": 7, "pred_score": 0.3349999999999999}, {"true_label": 0, "pred_label": 0, "pred_score": 0.355952380952381}, {"true_label": 4, "pred_label": 4, "pred_score": 0.7103095238095237}, {"true_label": 2, "pred_label": 2, "pred_score": 0.5085555555555556}, {"true_label": 9, "pred_label": 9, "pred_score": 0.8303333333333331}, {"true_label": 1, "pred_label": 1, "pred_score": 0.4837976190476191}, {"true_label": 0, "pred_label": 0, "pred_score": 0.991}, {"true_label": 4, "pred_label": 4, "pred_score": 0.8830476190476191}, {"true_label": 6, "pred_label": 6, "pred_score": 0.7130357142857142}, {"true_label": 3, "pred_label": 3, "pred_score": 0.985}, {"true_label": 1, "pred_label": 1, "pred_score": 0.6959563492063492}, {"true_label": 6, "pred_label": 6, "pred_score": 0.976}, {"true_label": 5, "pred_label": 5, "pred_score": 0.8951666666666667}, {"true_label": 4, "pred_label": 4, "pred_score": 0.9579761904761905}, {"true_label": 5, "pred_label": 5, "pred_score": 0.992}, {"true_label": 8, "pred_label": 1, "pred_score": 0.39546825396825397}, {"true_label": 8, "pred_label": 8, "pred_score": 0.8184999999999999}, {"true_label": 2, "pred_label": 2, "pred_score": 0.9416666666666668}, {"true_label": 7, "pred_label": 7, "pred_score": 0.45053571428571426}, {"true_label": 9, "pred_label": 9, "pred_score": 0.3258690476190476}, {"true_label": 6, "pred_label": 6, "pred_score": 0.8483333333333334}, {"true_label": 1, "pred_label": 1, "pred_score": 0.7513690476190478}, {"true_label": 1, "pred_label": 1, "pred_score": 0.5081666666666667}];
      const tooltip = d3.select("#tooltip");

      let bookmarkedInstances = new Set();
      let polylinesVisible = false;
      let currentFilter = "all";
      let instanceIdCounter = 0;

      const data = raw_instances.map(d => {
        return {
          ...d,
          match: (d.true_label === d.pred_label) ? "TP" : "FN",
          class_focus: d.true_label,
          instance_id: instanceIdCounter++
        };
      });

      const colors = d3.schemeCategory10;

      function updateBookmarkCount() {
        document.getElementById("bookmark-count").textContent = `${bookmarkedInstances.size} instances`;
      }

      function shouldShowInstance(dataPoint) {
        if (currentFilter === "bookmarked" && !bookmarkedInstances.has(dataPoint.instance_id)) return false;
        if (currentFilter === "tp" && dataPoint.match !== "TP") return false;
        if (currentFilter === "fp" && dataPoint.match !== "FP") return false;
        if (currentFilter === "fn" && dataPoint.match !== "FN") return false;
        if (currentFilter === "high-confidence" && dataPoint.pred_score < 0.8) return false;
        if (currentFilter === "low-confidence" && dataPoint.pred_score >= 0.5) return false;
        return true;
      }

      // Generate confusion analysis report
      function generateConfusionReport() {
        const confusionData = {};
        const classStats = {};

        // Initialize statistics
        data.forEach(d => {
          if (!classStats[d.true_label]) {
            classStats[d.true_label] = {TP: 0, FP: 0, FN: 0, total: 0};
          }
          if (!classStats[d.pred_label]) {
            classStats[d.pred_label] = {TP: 0, FP: 0, FN: 0, total: 0};
          }

          classStats[d.true_label].total++;

          if (d.true_label === d.pred_label) {
            classStats[d.true_label].TP++;
          } else {
            classStats[d.true_label].FN++;
            classStats[d.pred_label].FP++;

            // Record confusion pairs
            const confusionKey = `${d.true_label}->${d.pred_label}`;
            if (!confusionData[confusionKey]) {
              confusionData[confusionKey] = {count: 0, avgScore: 0, instances: []};
            }
            confusionData[confusionKey].count++;
            confusionData[confusionKey].instances.push(d);
          }
        });

        // Calculate average scores
        Object.keys(confusionData).forEach(key => {
          const confusion = confusionData[key];
          confusion.avgScore = confusion.instances.reduce((sum, inst) => sum + inst.pred_score, 0) / confusion.count;
        });

        // Generate report HTML
        let reportHtml = `
          <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                      background: white; border: 2px solid #333; border-radius: 8px; padding: 20px; 
                      box-shadow: 0 4px 16px rgba(0,0,0,0.3); z-index: 10000; max-width: 600px; max-height: 500px; overflow-y: auto;">
            <h3 style="margin-top: 0; color: #333;">üìä Confusion Analysis Report</h3>

            <div style="background: #f8f9fa; padding: 15px; border-radius: 4px; margin-bottom: 15px;">
              <h4 style="margin: 0 0 10px 0;">Class Performance Summary</h4>
              <div style="display: grid; grid-template-columns: auto auto auto auto auto; gap: 10px; font-size: 12px; font-weight: bold; border-bottom: 1px solid #ddd; padding-bottom: 5px;">
                <div>Class</div><div>Precision</div><div>Recall</div><div>F1-Score</div><div>Support</div>
              </div>`;

        Object.keys(classStats).sort((a,b) => a-b).forEach(cls => {
          const stats = classStats[cls];
          const precision = stats.TP / (stats.TP + stats.FP) || 0;
          const recall = stats.TP / (stats.TP + stats.FN) || 0;
          const f1 = 2 * precision * recall / (precision + recall) || 0;

          reportHtml += `
            <div style="display: grid; grid-template-columns: auto auto auto auto auto; gap: 10px; font-size: 12px; padding: 3px 0;">
              <div>C${cls}</div>
              <div>${precision.toFixed(3)}</div>
              <div>${recall.toFixed(3)}</div>
              <div>${f1.toFixed(3)}</div>
              <div>${stats.total}</div>
            </div>`;
        });

        reportHtml += `
              </div>

            <div style="background: #fff3cd; padding: 15px; border-radius: 4px; margin-top: 15px;">
              <h4 style="margin: 0 0 10px 0; color: #856404;">‚ö†Ô∏è Top Confusion Patterns</h4>`;

        // Show top 5 most common confusions
        const topConfusions = Object.entries(confusionData)
          .sort(([,a], [,b]) => b.count - a.count)
          .slice(0, 5);

        topConfusions.forEach(([pattern, data]) => {
          const [from, to] = pattern.split('->');
          reportHtml += `
            <div style="margin: 5px 0; padding: 8px; background: rgba(255,193,7,0.1); border-left: 3px solid #ffc107; font-size: 12px;">
              <strong>C${from} ‚Üí C${to}</strong>: ${data.count} instances (avg confidence: ${data.avgScore.toFixed(3)})
            </div>`;
        });

        reportHtml += `
              </div>

            <div style="text-align: center; margin-top: 20px;">
              <button onclick="this.parentElement.parentElement.remove()" 
                      style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                Close Report
              </button>
            </div>
          </div>`;

        document.body.insertAdjacentHTML('beforeend', reportHtml);
      }

      // Complete polylines functionality based on Squares paper design
      function drawPolylines(svg, data, classSet, subplotWidth) {
        if (!polylinesVisible) return;

        const polylineGroup = svg.select(".polyline-group");
        if (polylineGroup.empty()) {
          svg.append("g").attr("class", "polyline-group");
        }

        svg.select(".polyline-group").selectAll("*").remove();

        // Generate all class prediction scores for each instance (simulating paper's parallel coordinates)
        const enhancedData = data.map(d => {
          // Simulate score distribution across all classes for this instance
          const allClassScores = classSet.map(cls => {
            if (cls === d.pred_label) {
              return d.pred_score; // Use actual score for predicted class
            } else if (cls === d.true_label && d.true_label !== d.pred_label) {
              // If true class but not predicted, give medium score
              return Math.max(0.1, d.pred_score * 0.3 + Math.random() * 0.2);
            } else {
              // Other classes get lower scores with some randomness
              return Math.random() * 0.3;
            }
          });

          return {
            ...d,
            allClassScores: allClassScores
          };
        });

        // Draw aggregated class confusion polylines (to show overall confusion patterns)
        const confusionMatrix = {};
        enhancedData.forEach(d => {
          if (d.true_label !== d.pred_label) {
            const key = `${d.true_label}-${d.pred_label}`;
            if (!confusionMatrix[key]) {
              confusionMatrix[key] = {
                from: d.true_label,
                to: d.pred_label,
                instances: [],
                avgScore: 0
              };
            }
            confusionMatrix[key].instances.push(d);
          }
        });

        // Draw aggregated polyline for each confusion pair
        Object.values(confusionMatrix).forEach(confusion => {
          const avgScore = confusion.instances.reduce((sum, inst) => sum + inst.pred_score, 0) / confusion.instances.length;
          const intensity = Math.min(confusion.instances.length / 5, 1); // Adjust opacity based on instance count

          const fromX = classSet.indexOf(confusion.from) * subplotWidth + 50 + subplotWidth/2;
          const toX = classSet.indexOf(confusion.to) * subplotWidth + 50 + subplotWidth/2;
          const y = 400 - avgScore * 300;

          // Draw curved connection line, simulating paper's parallel coordinates connections
          const midX = (fromX + toX) / 2;
          const controlY = y - 40 - Math.abs(toX - fromX) * 0.1; // Control point height

          svg.select(".polyline-group").append("path")
            .attr("d", `M ${fromX} ${y} Q ${midX} ${controlY} ${toX} ${y}`)
            .attr("stroke", "#ff6b35")
            .attr("stroke-width", Math.max(1, confusion.instances.length * 0.5))
            .attr("fill", "none")
            .attr("opacity", 0.4 + intensity * 0.4)
            .attr("class", "confusion-polyline")
            .style("pointer-events", "none");

          // Add instance count labels on connection lines
          if (confusion.instances.length > 2) {
            svg.select(".polyline-group").append("text")
              .attr("x", midX)
              .attr("y", controlY - 5)
              .attr("text-anchor", "middle")
              .attr("font-size", "10px")
              .attr("fill", "#666")
              .text(confusion.instances.length);
          }
        });

        // Store enhanced data for hover use
        svg.node().__enhancedData = enhancedData;
      }

      // Show detailed polyline for individual instance
      function showInstancePolyline(svg, instance, classSet, subplotWidth) {
        if (!instance.allClassScores) return;

        const polylineGroup = svg.select(".polyline-group");

        // Clear previous instance polylines
        polylineGroup.selectAll(".instance-polyline").remove();
        polylineGroup.selectAll(".score-dot").remove();

        // Create score point data
        const scorePoints = instance.allClassScores.map((score, idx) => {
          const classIdx = classSet[idx];
          const x = classIdx * subplotWidth + 50 + subplotWidth/2;
          const y = 400 - score * 300;
          return { x, y, score, classIdx, isTrue: classIdx === instance.true_label, isPred: classIdx === instance.pred_label };
        });

        // Draw polyline connecting all classes (parallel coordinate style)
        const line = d3.line()
          .x(d => d.x)
          .y(d => d.y)
          .curve(d3.curveLinear);

        polylineGroup.append("path")
          .datum(scorePoints)
          .attr("class", "instance-polyline")
          .attr("d", line)
          .attr("stroke", "#ff6b35")
          .attr("stroke-width", 2)
          .attr("fill", "none")
          .attr("opacity", 0.8)
          .style("pointer-events", "none");

        // Draw score dots on each class axis
        polylineGroup.selectAll(".score-dot")
          .data(scorePoints)
          .enter()
          .append("circle")
          .attr("class", "score-dot")
          .attr("cx", d => d.x)
          .attr("cy", d => d.y)
          .attr("r", d => d.isPred ? 5 : (d.isTrue ? 4 : 3))
          .attr("fill", d => {
            if (d.isPred) return "#ff6b35"; // Predicted class in orange
            if (d.isTrue) return "#2ecc71"; // True class in green
            return "#95a5a6"; // Other classes in gray
          })
          .attr("stroke", "#fff")
          .attr("stroke-width", 1)
          .attr("opacity", 0.9)
          .style("pointer-events", "none");

        // Add score labels (only for important points)
        scorePoints.forEach(point => {
          if (point.isPred || point.isTrue || point.score > 0.5) {
            polylineGroup.append("text")
              .attr("x", point.x + 8)
              .attr("y", point.y + 3)
              .attr("font-size", "9px")
              .attr("fill", "#333")
              .attr("class", "score-dot")
              .text(point.score.toFixed(2));
          }
        });
      }

      // Hide instance polyline
      function hideInstancePolyline(svg) {
        const polylineGroup = svg.select(".polyline-group");
        polylineGroup.selectAll(".instance-polyline").remove();
        polylineGroup.selectAll(".score-dot").remove();
      }

      function draw(view_mode) {
        d3.select("#multi-class-vis").html("");

        const boxSize = 16, spacing = 3, rowsPerBin = 8;
        const binHeight = 0.1;
        const maxBin = 10;
        const classSet = [...new Set(data.map(d => d.class_focus))].sort((a, b) => a - b);
        const subplotWidth = 280;  
        const svgHeight = 800;     
        const svgWidth = Math.max(subplotWidth * classSet.length + 150, 1500);

        const svg = d3.select("#multi-class-vis").append("svg")
          .attr("width", svgWidth)
          .attr("height", svgHeight)
          .attr("viewBox", `0 0 ${svgWidth} ${svgHeight}`)
          .style("max-width", "none")
          .style("max-height", "none")
          .style("width", svgWidth + "px")
          .style("height", svgHeight + "px")
          .style("display", "block")
          .style("background-color", "white")
          .style("border-radius", "8px")
          .style("box-shadow", "0 4px 8px rgba(0,0,0,0.1)");

        const mainContent = svg.append("g").attr("class", "main-content");
        svg.append("g").attr("class", "polyline-group");

        // Create a horizontal group for each category
        const group = mainContent.selectAll("g")
          .data(classSet)
          .enter().append("g")
          .attr("transform", (d, i) => `translate(${i * subplotWidth + 50}, 50)`); 

        // Add Category Title
        group.append("text")
          .text(d => `Class ${d}`)
          .attr("x", subplotWidth/2)
          .attr("y", -15)
          .attr("text-anchor", "middle")
          .style("font-weight", "bold")
          .style("font-size", "20px")  
          .style("fill", "#333");

        // Add Y axis label (only in the first subplot)
        mainContent.append("text")
          .text("Prediction Score")
          .attr("x", 25)
          .attr("y", svgHeight/2)
          .attr("text-anchor", "middle")
          .attr("transform", `rotate(-90, 25, ${svgHeight/2})`)
          .style("font-size", "16px")  
          .style("font-weight", "bold")
          .style("fill", "#333");

        // Plot the data for each category
        group.each(function(cls, classIdx) {
          const g = d3.select(this);
          const filtered = data.filter(d => d.class_focus === cls);

          // Calculate statistics
          const stats = {TP: 0, FP: 0, FN: 0};
          filtered.forEach(d => {
            if (d.match === "TP") stats.TP++;
            else stats.FN++;
          });
          // Calculate FP (other categories are incorrectly predicted as the current category)
          data.forEach(d => {
            if (d.pred_label === cls && d.true_label !== cls) stats.FP++;
          });

          // Add statistics
          const precision = stats.TP / (stats.TP + stats.FP) || 0;
          const recall = stats.TP / (stats.TP + stats.FN) || 0;
          const f1 = 2 * precision * recall / (precision + recall) || 0;

          g.append("text")
            .text(`TP: ${stats.TP} FP: ${stats.FP} FN: ${stats.FN}`)
            .attr("x", subplotWidth/2)
            .attr("y", svgHeight - 80)
            .attr("text-anchor", "middle")
            .style("font-size", "14px")  
            .style("font-weight", "bold")
            .style("fill", "#555");

          g.append("text")
            .text(`P: ${precision.toFixed(2)} R: ${recall.toFixed(2)} F1: ${f1.toFixed(2)}`)
            .attr("x", subplotWidth/2)
            .attr("y", svgHeight - 60)
            .attr("text-anchor", "middle")
            .style("font-size", "14px")  
            .style("font-weight", "bold")
            .style("fill", "#555");

          // Add Y-axis scale (only in the first subplot)
          if (classIdx === 0) {
            const yScale = d3.scaleLinear()
              .domain([0, 1])
              .range([svgHeight - 120, 70]); 

            const yAxis = d3.axisLeft(yScale).ticks(10);
            g.append("g")
              .attr("transform", "translate(-10, 0)")  
              .call(yAxis)
              .selectAll("text")
              .style("font-size", "12px");
          }

          // Create binned array
          const byBin = Array.from({length: maxBin}, () => []);
          filtered.forEach(d => {
            const bin = Math.min(Math.floor(d.pred_score * 10), 9);
            const key = view_mode === "stacks" ? 0 : bin;
            byBin[key].push(d);
          });

          // Plot the data for each bin
          byBin.forEach((binData, binIdx) => {
            if (binData.length === 0) return;

            const y_base = view_mode === "stacks" ? 
              svgHeight - 170 : 
              (svgHeight - 170) - (binIdx * (svgHeight - 250) / 10);  

            const counters = {TP: 0, FN: 0};

            binData.forEach(dataPoint => {
              if (!shouldShowInstance(dataPoint)) return; 

              const match = dataPoint.match;
              const count = counters[match]++;
              const row = Math.floor(count / rowsPerBin);
              const col = count % rowsPerBin;

              const x = col * (boxSize + spacing) + 10;
              const y = y_base - row * (boxSize + spacing);

              let fill = "none", stroke = "black";
              if (match === "TP") {
                fill = colors[dataPoint.true_label % colors.length];
              }
              if (match === "FN") {
                stroke = colors[dataPoint.pred_label % colors.length];
                fill = "none";
              }

              const isBookmarked = bookmarkedInstances.has(dataPoint.instance_id);

              g.append("rect")
                .datum(dataPoint) 
                .attr("x", x)
                .attr("y", y)
                .attr("width", boxSize)
                .attr("height", boxSize)
                .attr("fill", fill)
                .attr("stroke", isBookmarked ? "#ff6b6b" : stroke)
                .attr("stroke-width", isBookmarked ? 3 : 1.5)
                .style("opacity", isBookmarked ? 1 : 0.8)
                .style("cursor", "pointer")
                .attr("class", `instance-${dataPoint.instance_id}`);

            });
          });

          // Add FP data (other categories are incorrectly predicted as the current category)
          const fpData = data.filter(d => d.pred_label === cls && d.true_label !== cls);
          const fpByBin = Array.from({length: maxBin}, () => []);
          fpData.forEach(d => {
            const bin = Math.min(Math.floor(d.pred_score * 10), 9);
            const key = view_mode === "stacks" ? 0 : bin;
            fpByBin[key].push(d);
          });

          fpByBin.forEach((binData, binIdx) => {
            if (binData.length === 0) return;

            const y_base = view_mode === "stacks" ? 
              svgHeight - 170 : 
              (svgHeight - 170) - (binIdx * (svgHeight - 250) / 10); 

            let fpCount = 0;
            binData.forEach(dataPoint => {
              if (!shouldShowInstance({...dataPoint, match: "FP"})) return;  

              const row = Math.floor(fpCount / rowsPerBin);
              const col = fpCount % rowsPerBin;

              const x = col * (boxSize + spacing) + subplotWidth/2 + 10;
              const y = y_base - row * (boxSize + spacing);

              const fpDataPoint = {...dataPoint, match: "FP"};
              const isBookmarked = bookmarkedInstances.has(dataPoint.instance_id);

              g.append("rect")
                .datum(fpDataPoint)  
                .attr("x", x)
                .attr("y", y)
                .attr("width", boxSize)
                .attr("height", boxSize)
                .attr("fill", colors[dataPoint.true_label % colors.length])
                .attr("stroke", isBookmarked ? "#ff6b6b" : "black")
                .attr("stroke-width", isBookmarked ? 3 : 1.5)
                .style("fill-opacity", 0.6)
                .style("opacity", isBookmarked ? 1 : 0.8)
                .style("cursor", "pointer")
                .attr("class", `instance-${dataPoint.instance_id}`);

              fpCount++;
            });
          });
        });

        // SVG tooltip
        const svgTooltip = svg.append("g")
          .attr("class", "tooltip-group")
          .style("display", "none")
          .style("pointer-events", "none");

        svgTooltip.append("rect")
          .attr("class", "tooltip-bg")
          .attr("fill", "white")
          .attr("stroke", "#ccc")
          .attr("stroke-width", 1)
          .attr("rx", 3)
          .style("filter", "drop-shadow(2px 2px 4px rgba(0,0,0,0.3))");

        svgTooltip.append("text")
          .attr("class", "tooltip-text")
          .attr("fill", "black")
          .style("font-size", "12px")
          .attr("x", 5)
          .attr("y", 15);

        // Add interactions to all rectangles
        svg.selectAll("rect").each(function() {
          const rect = d3.select(this);
          const dataPoint = rect.datum();
          if (dataPoint && dataPoint.true_label !== undefined) {
            rect
              .on("mouseover", function(event) {
                const isBookmarked = bookmarkedInstances.has(dataPoint.instance_id);
                const bookmarkStatus = isBookmarked ? "‚≠ê " : "";
                const tooltipText = dataPoint.match === "FP" ? 
                  `${bookmarkStatus}FP T:${dataPoint.true_label} P:${dataPoint.pred_label} S:${dataPoint.pred_score.toFixed(2)}` :
                  `${bookmarkStatus}T:${dataPoint.true_label} P:${dataPoint.pred_label} S:${dataPoint.pred_score.toFixed(2)}`;
                const textWidth = tooltipText.length * 7;

                svgTooltip.select(".tooltip-text").text(tooltipText);
                svgTooltip.select(".tooltip-bg")
                  .attr("width", textWidth + 10)
                  .attr("height", 20);
                svgTooltip.style("display", "block");

                // Show instance polyline when hovering (based on Squares paper)
                if (polylinesVisible) {
                  const enhancedData = svg.node().__enhancedData || [];
                  const enhancedInstance = enhancedData.find(d => d.instance_id === dataPoint.instance_id);

                  if (enhancedInstance) {
                    // Fade aggregate polylines
                    svg.selectAll(".confusion-polyline").style("opacity", 0.15);
                    // Show detailed instance polyline
                    showInstancePolyline(svg, enhancedInstance, classSet, subplotWidth);
                  }
                }
              })
              .on("mousemove", function(event) {
                const [mouseX, mouseY] = d3.pointer(event, svg.node());
                svgTooltip.attr("transform", `translate(${mouseX + 15}, ${Math.max(mouseY - 35, 5)})`);
              })
              .on("mouseout", function() {
                svgTooltip.style("display", "none");

                if (polylinesVisible) {
                  // Restore aggregate polylines opacity
                  svg.selectAll(".confusion-polyline").style("opacity", null);
                  // Hide instance polyline
                  hideInstancePolyline(svg);
                }
              })
              .on("click", function(event) {
                event.stopPropagation();

                if (bookmarkedInstances.has(dataPoint.instance_id)) {
                  bookmarkedInstances.delete(dataPoint.instance_id);
                } else {
                  bookmarkedInstances.add(dataPoint.instance_id);
                }
                updateBookmarkCount();

                // Redraw while maintaining polylines state
                draw(view_mode);
              })
              .on("dblclick", function(event) {
                event.stopPropagation();
                // Show enhanced instance details with all class scores
                showEnhancedInstanceDetails(dataPoint, svg.node().__enhancedData);
              });
          }
        });

        // Draw polylines
        drawPolylines(svg, data, classSet, subplotWidth);

        // Draw sparklines (small line charts above classes showing average score distribution)
        if (polylinesVisible) {
          classSet.forEach((cls, classIdx) => {
            const classInstances = data.filter(d => d.true_label === cls);
            if (classInstances.length === 0) return;

            // Calculate average scores for this class across all classes
            const enhancedData = svg.node().__enhancedData || [];
            const classEnhancedInstances = enhancedData.filter(d => d.true_label === cls);

            if (classEnhancedInstances.length > 0) {
              const avgScores = classSet.map(targetCls => {
                const scores = classEnhancedInstances.map(inst => 
                  inst.allClassScores[classSet.indexOf(targetCls)] || 0
                );
                return scores.reduce((a, b) => a + b, 0) / scores.length;
              });

              // Create sparkline path
              const sparklinePoints = avgScores.map((score, idx) => {
                const x = idx * subplotWidth + 50 + subplotWidth/2;
                const y = 20 + (1 - score) * 20; // Draw at top, invert y coordinate
                return {x, y};
              });

              const sparkline = d3.line()
                .x(d => d.x)
                .y(d => d.y)
                .curve(d3.curveCardinal);

              // Draw sparkline background
              svg.append("rect")
                .attr("x", classIdx * subplotWidth + 50 + 10)
                .attr("y", 5)
                .attr("width", subplotWidth - 20)
                .attr("height", 35)
                .attr("fill", "rgba(255, 255, 255, 0.8)")
                .attr("stroke", "#ddd")
                .attr("stroke-width", 1)
                .attr("rx", 3);

              // Draw sparkline
              svg.append("path")
                .datum(sparklinePoints)
                .attr("d", sparkline)
                .attr("stroke", colors[cls % colors.length])
                .attr("stroke-width", 1.5)
                .attr("fill", "none")
                .attr("opacity", 0.7);

              // Mark highest peak (show main confusion)
              const maxScoreIdx = avgScores.indexOf(Math.max(...avgScores));
              if (maxScoreIdx !== classSet.indexOf(cls)) { // If highest peak is not itself
                svg.append("circle")
                  .attr("cx", sparklinePoints[maxScoreIdx].x)
                  .attr("cy", sparklinePoints[maxScoreIdx].y)
                  .attr("r", 2)
                  .attr("fill", "#e74c3c");
              }

              // Add sparkline title
              svg.append("text")
                .attr("x", classIdx * subplotWidth + 50 + subplotWidth/2)
                .attr("y", 15)
                .attr("text-anchor", "middle")
                .attr("font-size", "8px")
                .attr("fill", "#666")
                .text(`C${cls} Distribution`);
            }
          });
        }
      }

      // Enhanced instance details display with all class scores
      function showEnhancedInstanceDetails(dataPoint, enhancedData) {
        const enhancedInstance = enhancedData ? enhancedData.find(d => d.instance_id === dataPoint.instance_id) : null;
        const allScoresText = enhancedInstance ? 
          enhancedInstance.allClassScores.map((score, idx) => `C${idx}: ${score.toFixed(3)}`).join(', ') :
          'Not available';

        const detailsHtml = `
          <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                      background: white; border: 2px solid #333; border-radius: 8px; padding: 20px; 
                      box-shadow: 0 4px 16px rgba(0,0,0,0.3); z-index: 10000; max-width: 500px; max-height: 400px; overflow-y: auto;">
            <h3 style="margin-top: 0; color: #333;">üîç Enhanced Instance Details</h3>
            <div style="background: #f8f9fa; padding: 10px; border-radius: 4px; margin-bottom: 15px;">
              <p style="margin: 5px 0;"><strong>Instance ID:</strong> ${dataPoint.instance_id}</p>
              <p style="margin: 5px 0;"><strong>True Label:</strong> <span style="color: #2ecc71; font-weight: bold;">C${dataPoint.true_label}</span></p>
              <p style="margin: 5px 0;"><strong>Predicted Label:</strong> <span style="color: #ff6b35; font-weight: bold;">C${dataPoint.pred_label}</span></p>
              <p style="margin: 5px 0;"><strong>Confidence Score:</strong> ${dataPoint.pred_score.toFixed(3)}</p>
              <p style="margin: 5px 0;"><strong>Classification:</strong> 
                <span style="color: ${dataPoint.match === 'TP' ? '#2ecc71' : '#e74c3c'}; font-weight: bold;">
                  ${dataPoint.match === 'TP' ? '‚úì Correct' : '‚úó ' + dataPoint.match}
                </span>
              </p>
              <p style="margin: 5px 0;"><strong>Bookmarked:</strong> ${bookmarkedInstances.has(dataPoint.instance_id) ? "Yes ‚≠ê" : "No"}</p>
            </div>

            <div style="background: #fff3cd; padding: 10px; border-radius: 4px; border-left: 4px solid #ff6b35;">
              <h4 style="margin: 0 0 10px 0; color: #856404;">üìä All Class Prediction Scores</h4>
              <p style="margin: 0; font-size: 12px; font-family: monospace; line-height: 1.4;">
                ${allScoresText}
              </p>
              ${enhancedInstance ? `
                <div style="margin-top: 10px; font-size: 11px; color: #666;">
                  <em>üéØ Prediction confidence: ${(Math.max(...enhancedInstance.allClassScores) / (enhancedInstance.allClassScores.reduce((a,b) => a+b, 0) / enhancedInstance.allClassScores.length)).toFixed(2)}x above average</em>
                </div>
              ` : ''}
            </div>

            ${dataPoint.match !== 'TP' ? `
              <div style="background: #f8d7da; padding: 10px; border-radius: 4px; margin-top: 10px; border-left: 4px solid #e74c3c;">
                <h4 style="margin: 0 0 5px 0; color: #721c24;">‚ö†Ô∏è Error Analysis</h4>
                <p style="margin: 0; font-size: 12px;">
                  This instance was misclassified. 
                  ${enhancedInstance && enhancedInstance.allClassScores[dataPoint.true_label] ? 
                    `True class C${dataPoint.true_label} had score: ${enhancedInstance.allClassScores[dataPoint.true_label].toFixed(3)}` : 
                    ''}
                </p>
              </div>
            ` : ''}

            <div style="text-align: center; margin-top: 20px;">
              <button onclick="this.parentElement.parentElement.remove()" 
                      style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">
                Close
              </button>
              <button onclick="navigator.clipboard.writeText('Instance ${dataPoint.instance_id}: T=${dataPoint.true_label}, P=${dataPoint.pred_label}, S=${dataPoint.pred_score.toFixed(3)}')" 
                      style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                Copy Info
              </button>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML('beforeend', detailsHtml);
      }

      // Event listeners
      const selector = document.getElementById("view_mode");
      if (selector) {
        selector.addEventListener("change", e => draw(e.target.value));
      }

      document.getElementById("toggle-polylines").addEventListener("click", function() {
        polylinesVisible = !polylinesVisible;
        this.textContent = polylinesVisible ? "Hide" : "Show";
        this.style.background = polylinesVisible ? "#e74c3c" : "#2ecc71";
        draw(selector ? selector.value : "boxes");
      });

      document.getElementById("clear-bookmarks").addEventListener("click", function() {
        bookmarkedInstances.clear();
        updateBookmarkCount();
        draw(selector ? selector.value : "boxes");
      });

      document.getElementById("instance-filter").addEventListener("change", function() {
        currentFilter = this.value;
        draw(selector ? selector.value : "boxes");
      });

      document.getElementById("confusion-analysis").addEventListener("click", function() {
        generateConfusionReport();
      });

      // Initialize
      updateBookmarkCount();
      draw("boxes");
    })();
    </script>
</body>
</html>